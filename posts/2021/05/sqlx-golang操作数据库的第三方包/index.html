<!doctype html><html lang=en>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="ie=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=author content="map[name:Reggie]">
<meta name=description content="一、简介
sqlx是一个操作数据库的库,它在golang标准包database/sql之上增加了很多扩展，简化数据库操作代码的书写.配合sql driver可支持mysql、postgresql.
sqlx设计和database/sql使用方法是一样的.包含有4中主要的handle types:
 sqlx.DB - 和sql.DB相似，表示数据库. sqlx.Tx - 和sql.Tx相似，表示transacion。 sqlx.Stmt - 和sql.Stmt相似，表示prepared statement. sqlx.NamedStmt - 表示prepared statement（支持named parameters）  所有的handler types都提供了对database/sql的兼容，意味着当你调用sql.DB.Query时,可以直接替换为sqlx.DB.Query.这就使得sqlx可以很容易的加入到已有的数据库项目中.
此外，sqlx还有两个cursor类型:
 sqlx.Rows - 和sql.Rows类似，Queryx返回. sqlx.Row - 和sql.Row类似，QueryRowx返回.  二、使用
1.获取DB对象(sqlx.Open())
// Open is the same as sql.Open, but returns an *sqlx.DB instead. func Open(driverName, dataSourceName string) (*DB, error) { db, err := sql.Open(driverName, dataSourceName) if err != nil { return nil, err } return &amp;amp;DB{DB: db, driverName: driverName, Mapper: mapper()}, err } sqlx.">
<meta name=keywords content=",golang,go,sqlx">
<meta name=robots content="noodp">
<meta name=theme-color content>
<link rel=canonical href=https://reggieteng.github.io/posts/2021/05/sqlx-golang%E6%93%8D%E4%BD%9C%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E7%AC%AC%E4%B8%89%E6%96%B9%E5%8C%85/>
<title>
sqlx--golang操作数据库的第三方包 :: Hello — Hello Friends
</title>
<link href=https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.5.0/css/flag-icon.min.css rel=stylesheet type=text/css>
<link rel=stylesheet href=https://reggieteng.github.io/main.031a8efc33f94f55a4071bf4e91596478a5809fc8c148fab113801189cfd2152.css>
<link rel=apple-touch-icon sizes=180x180 href=https://reggieteng.github.io/apple-touch-icon.png>
<link rel=icon type=image/png sizes=32x32 href=https://reggieteng.github.io/favicon-32x32.png>
<link rel=icon type=image/png sizes=16x16 href=https://reggieteng.github.io/favicon-16x16.png>
<link rel=manifest href=https://reggieteng.github.io/site.webmanifest>
<link rel=mask-icon href=https://reggieteng.github.io/safari-pinned-tab.svg color=#1b1c1d>
<link rel="shortcut icon" href=https://reggieteng.github.io/favicon.ico>
<meta name=msapplication-TileColor content="#1b1c1d">
<meta name=theme-color content="#1b1c1d">
<meta itemprop=name content="sqlx--golang操作数据库的第三方包">
<meta itemprop=description content="一、简介
sqlx是一个操作数据库的库,它在golang标准包database/sql之上增加了很多扩展，简化数据库操作代码的书写.配合sql driver可支持mysql、postgresql.
sqlx设计和database/sql使用方法是一样的.包含有4中主要的handle types:
 sqlx.DB - 和sql.DB相似，表示数据库. sqlx.Tx - 和sql.Tx相似，表示transacion。 sqlx.Stmt - 和sql.Stmt相似，表示prepared statement. sqlx.NamedStmt - 表示prepared statement（支持named parameters）  所有的handler types都提供了对database/sql的兼容，意味着当你调用sql.DB.Query时,可以直接替换为sqlx.DB.Query.这就使得sqlx可以很容易的加入到已有的数据库项目中.
此外，sqlx还有两个cursor类型:
 sqlx.Rows - 和sql.Rows类似，Queryx返回. sqlx.Row - 和sql.Row类似，QueryRowx返回.  二、使用
1.获取DB对象(sqlx.Open())
// Open is the same as sql.Open, but returns an *sqlx.DB instead. func Open(driverName, dataSourceName string) (*DB, error) { db, err := sql.Open(driverName, dataSourceName) if err != nil { return nil, err } return &DB{DB: db, driverName: driverName, Mapper: mapper()}, err } sqlx."><meta itemprop=datePublished content="2021-05-14T00:00:00+00:00">
<meta itemprop=dateModified content="2021-05-14T00:00:00+00:00">
<meta itemprop=wordCount content="779"><meta itemprop=image content="https://reggieteng.github.io">
<meta itemprop=keywords content="golang,go,sqlx,">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://reggieteng.github.io">
<meta name=twitter:title content="sqlx--golang操作数据库的第三方包">
<meta name=twitter:description content="一、简介
sqlx是一个操作数据库的库,它在golang标准包database/sql之上增加了很多扩展，简化数据库操作代码的书写.配合sql driver可支持mysql、postgresql.
sqlx设计和database/sql使用方法是一样的.包含有4中主要的handle types:
 sqlx.DB - 和sql.DB相似，表示数据库. sqlx.Tx - 和sql.Tx相似，表示transacion。 sqlx.Stmt - 和sql.Stmt相似，表示prepared statement. sqlx.NamedStmt - 表示prepared statement（支持named parameters）  所有的handler types都提供了对database/sql的兼容，意味着当你调用sql.DB.Query时,可以直接替换为sqlx.DB.Query.这就使得sqlx可以很容易的加入到已有的数据库项目中.
此外，sqlx还有两个cursor类型:
 sqlx.Rows - 和sql.Rows类似，Queryx返回. sqlx.Row - 和sql.Row类似，QueryRowx返回.  二、使用
1.获取DB对象(sqlx.Open())
// Open is the same as sql.Open, but returns an *sqlx.DB instead. func Open(driverName, dataSourceName string) (*DB, error) { db, err := sql.Open(driverName, dataSourceName) if err != nil { return nil, err } return &DB{DB: db, driverName: driverName, Mapper: mapper()}, err } sqlx.">
<meta property="og:title" content="sqlx--golang操作数据库的第三方包">
<meta property="og:description" content="一、简介
sqlx是一个操作数据库的库,它在golang标准包database/sql之上增加了很多扩展，简化数据库操作代码的书写.配合sql driver可支持mysql、postgresql.
sqlx设计和database/sql使用方法是一样的.包含有4中主要的handle types:
 sqlx.DB - 和sql.DB相似，表示数据库. sqlx.Tx - 和sql.Tx相似，表示transacion。 sqlx.Stmt - 和sql.Stmt相似，表示prepared statement. sqlx.NamedStmt - 表示prepared statement（支持named parameters）  所有的handler types都提供了对database/sql的兼容，意味着当你调用sql.DB.Query时,可以直接替换为sqlx.DB.Query.这就使得sqlx可以很容易的加入到已有的数据库项目中.
此外，sqlx还有两个cursor类型:
 sqlx.Rows - 和sql.Rows类似，Queryx返回. sqlx.Row - 和sql.Row类似，QueryRowx返回.  二、使用
1.获取DB对象(sqlx.Open())
// Open is the same as sql.Open, but returns an *sqlx.DB instead. func Open(driverName, dataSourceName string) (*DB, error) { db, err := sql.Open(driverName, dataSourceName) if err != nil { return nil, err } return &DB{DB: db, driverName: driverName, Mapper: mapper()}, err } sqlx.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://reggieteng.github.io/posts/2021/05/sqlx-golang%E6%93%8D%E4%BD%9C%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E7%AC%AC%E4%B8%89%E6%96%B9%E5%8C%85/"><meta property="og:image" content="https://reggieteng.github.io"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2021-05-14T00:00:00+00:00">
<meta property="article:modified_time" content="2021-05-14T00:00:00+00:00">
<meta property="og:see_also" content="https://reggieteng.github.io/posts/2021/11/mongndb%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/"><meta property="og:see_also" content="https://reggieteng.github.io/posts/2021/10/etcd%E7%9A%84%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/"><meta property="og:see_also" content="https://reggieteng.github.io/posts/2021/08/drone%E7%9A%84yml%E6%96%87%E4%BB%B6%E8%AF%A6%E8%A7%A3/"><meta property="og:see_also" content="https://reggieteng.github.io/posts/2021/08/nginx%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/"><meta property="og:see_also" content="https://reggieteng.github.io/posts/2021/04/golang-strconv/">
<meta property="article:section" content="golang">
<meta property="article:published_time" content="2021-05-14 00:00:00 +0000 UTC">
</head>
<body>
<div class=container>
<header class=header>
<span class=header__inner>
<a href=https://reggieteng.github.io/ style=text-decoration:none>
<div class=logo>
<span class=logo__mark>></span>
<span class=logo__text>$ cd /home/</span>
<span class=logo__cursor>
</span>
</div>
</a>
<span class=header__right>
<nav class=menu>
<ul class=menu__inner><li><a href=https://reggieteng.github.io/about/>About</a></li><li><a href=https://reggieteng.github.io/posts/>Posts</a></li>
</ul>
</nav>
<span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
</span>
</span>
</span>
</header>
<div class=content>
<main class=post>
<div class=post-info>
<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
4 minutes
</p>
</div>
<article>
<h1 class=post-title>
<a href=https://reggieteng.github.io/posts/2021/05/sqlx-golang%E6%93%8D%E4%BD%9C%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E7%AC%AC%E4%B8%89%E6%96%B9%E5%8C%85/>sqlx&ndash;golang操作数据库的第三方包</a>
</h1>
<div class=post-content>
<p>一、简介</p>
<p><a href=https://github.com/jmoiron/sqlx>sqlx</a>是一个操作数据库的库,它在golang标准包<code>database/sql</code>之上增加了很多扩展，简化数据库操作代码的书写.配合sql driver可支持mysql、postgresql.</p>
<p>sqlx设计和<code>database/sql</code>使用方法是一样的.包含有4中主要的handle types:</p>
<ul>
<li><code>sqlx.DB</code> - 和<code>sql.DB</code>相似，表示数据库.</li>
<li><code>sqlx.Tx</code> - 和<code>sql.Tx</code>相似，表示transacion。</li>
<li><code>sqlx.Stmt</code> - 和<code>sql.Stmt</code>相似，表示prepared statement.</li>
<li><code>sqlx.NamedStmt</code> - 表示prepared statement（支持named parameters）</li>
</ul>
<p>所有的handler types都提供了对<code>database/sql</code>的兼容，意味着当你调用<code>sql.DB.Query</code>时,可以直接替换为<code>sqlx.DB.Query</code>.这就使得sqlx可以很容易的加入到已有的数据库项目中.</p>
<p>此外，sqlx还有两个cursor类型:</p>
<ul>
<li><code>sqlx.Rows</code> - 和<code>sql.Rows</code>类似，Queryx返回.</li>
<li><code>sqlx.Row</code> - 和sql.Row类似，QueryRowx返回.</li>
</ul>
<p>二、使用</p>
<p>1.获取DB对象(sqlx.Open())</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=c1>// Open is the same as sql.Open, but returns an *sqlx.DB instead.
</span><span class=c1></span><span class=kd>func</span> <span class=nf>Open</span><span class=p>(</span><span class=nx>driverName</span><span class=p>,</span> <span class=nx>dataSourceName</span> <span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>DB</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
	<span class=nx>db</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>sql</span><span class=p>.</span><span class=nf>Open</span><span class=p>(</span><span class=nx>driverName</span><span class=p>,</span> <span class=nx>dataSourceName</span><span class=p>)</span>
	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
	<span class=p>}</span>
	<span class=k>return</span> <span class=o>&amp;</span><span class=nx>DB</span><span class=p>{</span><span class=nx>DB</span><span class=p>:</span> <span class=nx>db</span><span class=p>,</span> <span class=nx>driverName</span><span class=p>:</span> <span class=nx>driverName</span><span class=p>,</span> <span class=nx>Mapper</span><span class=p>:</span> <span class=nf>mapper</span><span class=p>()},</span> <span class=nx>err</span>
<span class=p>}</span>
</code></pre></div><p><code>sqlx.Open()</code>返回一个<code>sqlx.DB</code>是一个DB实例并不是一个链接,但是抽象表示了一个数据库.它内部维护了一个连接池,当需要进行连接的时候尝试连接.
在某些情况下,你或许需要直接获取数据库链接,此时你需要调用<code>sqlx.Connect()</code></p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=c1>// Connect to a database and verify with a ping.
</span><span class=c1></span><span class=kd>func</span> <span class=nf>Connect</span><span class=p>(</span><span class=nx>driverName</span><span class=p>,</span> <span class=nx>dataSourceName</span> <span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>DB</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
	<span class=nx>db</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>Open</span><span class=p>(</span><span class=nx>driverName</span><span class=p>,</span> <span class=nx>dataSourceName</span><span class=p>)</span>
	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
	<span class=p>}</span>
	<span class=nx>err</span> <span class=p>=</span> <span class=nx>db</span><span class=p>.</span><span class=nf>Ping</span><span class=p>()</span>
	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=nx>db</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
	<span class=p>}</span>
	<span class=k>return</span> <span class=nx>db</span><span class=p>,</span> <span class=kc>nil</span>
<span class=p>}</span>
</code></pre></div><p>2.数据操作</p>
<p>sqlx中的handle types实现了数据库查询相同的基本的操作语法。</p>
<ul>
<li><code>Exec(…)</code> (sql.Result, error) - 和<code>database/sql</code>相比没有改变</li>
<li><code>Query(…)</code> (*sql.Rows, error) - 和<code>database/sql</code>相比没有改变</li>
<li>``QueryRow(…)<code>*sql.Row - 和</code>database/sql`相比没有改变</li>
</ul>
<p><code>sqlx.NamedExec</code>方法用来绑定SQL语句与结构体或map中的同名字段.支持map,结构体,map列表,结构体列表</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go>    <span class=c1>// batch insert with map
</span><span class=c1></span>    <span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>db</span><span class=p>.</span><span class=nf>NamedExec</span><span class=p>(</span><span class=s>`INSERT INTO person (first_name,last_name,email) VALUES (:first,:last,:email)`</span><span class=p>,</span>
            <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{}{</span>
                <span class=s>&#34;first&#34;</span><span class=p>:</span> <span class=s>&#34;Bin&#34;</span><span class=p>,</span>
                <span class=s>&#34;last&#34;</span><span class=p>:</span> <span class=s>&#34;Smuth&#34;</span><span class=p>,</span>
                <span class=s>&#34;email&#34;</span><span class=p>:</span> <span class=s>&#34;bensmith@allblacks.nz&#34;</span><span class=p>,</span>
        <span class=p>})</span>
    <span class=c1>// batch insert with struct
</span><span class=c1></span>    <span class=nx>db</span><span class=p>.</span><span class=nf>NamedExec</span><span class=p>(</span><span class=s>&#34;INSERT INTO person (first_name, last_name, email) VALUES (:first_name, :last_name, :email)&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>Person</span><span class=p>{</span><span class=s>&#34;Jane&#34;</span><span class=p>,</span> <span class=s>&#34;Citizen&#34;</span><span class=p>,</span> <span class=s>&#34;jane.citzen@example.com&#34;</span><span class=p>})</span>

    <span class=c1>// batch insert with maps
</span><span class=c1></span>    <span class=nx>personMaps</span> <span class=o>:=</span> <span class=p>[]</span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{}{</span>
        <span class=p>{</span><span class=s>&#34;first_name&#34;</span><span class=p>:</span> <span class=s>&#34;Ardie&#34;</span><span class=p>,</span> <span class=s>&#34;last_name&#34;</span><span class=p>:</span> <span class=s>&#34;Savea&#34;</span><span class=p>,</span> <span class=s>&#34;email&#34;</span><span class=p>:</span> <span class=s>&#34;asavea@ab.co.nz&#34;</span><span class=p>},</span>
        <span class=p>{</span><span class=s>&#34;first_name&#34;</span><span class=p>:</span> <span class=s>&#34;Sonny Bill&#34;</span><span class=p>,</span> <span class=s>&#34;last_name&#34;</span><span class=p>:</span> <span class=s>&#34;Williams&#34;</span><span class=p>,</span> <span class=s>&#34;email&#34;</span><span class=p>:</span> <span class=s>&#34;sbw@ab.co.nz&#34;</span><span class=p>},</span>
        <span class=p>{</span><span class=s>&#34;first_name&#34;</span><span class=p>:</span> <span class=s>&#34;Ngani&#34;</span><span class=p>,</span> <span class=s>&#34;last_name&#34;</span><span class=p>:</span> <span class=s>&#34;Laumape&#34;</span><span class=p>,</span> <span class=s>&#34;email&#34;</span><span class=p>:</span> <span class=s>&#34;nlaumape@ab.co.nz&#34;</span><span class=p>},</span>
    <span class=p>}</span>

    <span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>db</span><span class=p>.</span><span class=nf>NamedExec</span><span class=p>(</span><span class=s>`INSERT INTO person (first_name, last_name, email)
</span><span class=s>        VALUES (:first_name, :last_name, :email)`</span><span class=p>,</span> <span class=nx>personMaps</span><span class=p>)</span>

    <span class=c1>// batch insert with structs
</span><span class=c1></span>    <span class=nx>personStructs</span> <span class=o>:=</span> <span class=p>[]</span><span class=nx>Person</span><span class=p>{</span>
        <span class=p>{</span><span class=nx>FirstName</span><span class=p>:</span> <span class=s>&#34;Ardie&#34;</span><span class=p>,</span> <span class=nx>LastName</span><span class=p>:</span> <span class=s>&#34;Savea&#34;</span><span class=p>,</span> <span class=nx>Email</span><span class=p>:</span> <span class=s>&#34;asavea@ab.co.nz&#34;</span><span class=p>},</span>
        <span class=p>{</span><span class=nx>FirstName</span><span class=p>:</span> <span class=s>&#34;Sonny Bill&#34;</span><span class=p>,</span> <span class=nx>LastName</span><span class=p>:</span> <span class=s>&#34;Williams&#34;</span><span class=p>,</span> <span class=nx>Email</span><span class=p>:</span> <span class=s>&#34;sbw@ab.co.nz&#34;</span><span class=p>},</span>
        <span class=p>{</span><span class=nx>FirstName</span><span class=p>:</span> <span class=s>&#34;Ngani&#34;</span><span class=p>,</span> <span class=nx>LastName</span><span class=p>:</span> <span class=s>&#34;Laumape&#34;</span><span class=p>,</span> <span class=nx>Email</span><span class=p>:</span> <span class=s>&#34;nlaumape@ab.co.nz&#34;</span><span class=p>},</span>
    <span class=p>}</span>

    <span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>db</span><span class=p>.</span><span class=nf>NamedExec</span><span class=p>(</span><span class=s>`INSERT INTO person (first_name, last_name, email)
</span><span class=s>        VALUES (:first_name, :last_name, :email)`</span><span class=p>,</span> <span class=nx>personStructs</span><span class=p>)</span>

</code></pre></div><p><code>db.NamedExec()</code>会返回sql.Result,结构体如下</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=c1>// A Result summarizes an executed SQL command.
</span><span class=c1></span><span class=kd>type</span> <span class=nx>Result</span> <span class=kd>interface</span> <span class=p>{</span>
	<span class=c1>// LastInsertId returns the integer generated by the database
</span><span class=c1></span>	<span class=c1>// in response to a command. Typically this will be from an
</span><span class=c1></span>	<span class=c1>// &#34;auto increment&#34; column when inserting a new row. Not all
</span><span class=c1></span>	<span class=c1>// databases support this feature, and the syntax of such
</span><span class=c1></span>	<span class=c1>// statements varies.
</span><span class=c1></span>	<span class=nf>LastInsertId</span><span class=p>()</span> <span class=p>(</span><span class=kt>int64</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span>

	<span class=c1>// RowsAffected returns the number of rows affected by an
</span><span class=c1></span>	<span class=c1>// update, insert, or delete. Not every database or database
</span><span class=c1></span>	<span class=c1>// driver may support this.
</span><span class=c1></span>	<span class=nf>RowsAffected</span><span class=p>()</span> <span class=p>(</span><span class=kt>int64</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span>
<span class=p>}</span>
</code></pre></div><p>注意:sql.Result不是支持所有数据库，如postgresql就需使用指定RETURNING,pg的<a href=https://github.com/lib/pq>driver</a>中有讲</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=c1>// pq does not support the LastInsertId() method of the Result type in database/sql.
</span><span class=c1>// To return the identifier of an INSERT (or UPDATE or DELETE), use the Postgres
</span><span class=c1>// RETURNING clause with a standard Query or QueryRow call:
</span><span class=c1></span>
<span class=c1>// 	var userid int
</span><span class=c1>// 	err := db.QueryRow(`INSERT INTO users(name, favorite_fruit, age)
</span><span class=c1>// 		VALUES(&#39;beatrice&#39;, &#39;starfruit&#39;, 93) RETURNING id`).Scan(&amp;userid)
</span></code></pre></div><p><code>db.NamedQuery</code>、<code>db.Queryx</code>方法用来查询数据.调用Query方法后,再调用<code>rows.StructScan()</code>才可以得到自定义的数据.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go>    <span class=c1>// Selects Mr. Smith from the database
</span><span class=c1></span>    <span class=nx>rows</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>db</span><span class=p>.</span><span class=nf>NamedQuery</span><span class=p>(</span><span class=s>`SELECT * FROM person WHERE first_name=:fn`</span><span class=p>,</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{}{</span><span class=s>&#34;fn&#34;</span><span class=p>:</span> <span class=s>&#34;Bin&#34;</span><span class=p>})</span>

    <span class=c1>// Named queries can also use structs.  Their bind names follow the same rules
</span><span class=c1></span>    <span class=c1>// as the name -&gt; db mapping, so struct fields are lowercased and the `db` tag
</span><span class=c1></span>    <span class=c1>// is taken into consideration.
</span><span class=c1></span>    <span class=nx>rows</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>db</span><span class=p>.</span><span class=nf>NamedQuery</span><span class=p>(</span><span class=s>`SELECT * FROM person WHERE first_name=:first_name`</span><span class=p>,</span> <span class=nx>jason</span><span class=p>)</span>

    <span class=nx>rows</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>db</span><span class=p>.</span><span class=nf>Queryx</span><span class=p>(</span><span class=s>&#34;SELECT * FROM place&#34;</span><span class=p>)</span>
    <span class=k>defer</span> <span class=nx>rows</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
    <span class=k>for</span> <span class=nx>rows</span><span class=p>.</span><span class=nf>Next</span><span class=p>()</span> <span class=p>{</span>
        <span class=nx>err</span> <span class=o>:=</span> <span class=nx>rows</span><span class=p>.</span><span class=nf>StructScan</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>place</span><span class=p>)</span>
        <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
            <span class=nx>log</span><span class=p>.</span><span class=nf>Fatalln</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
        <span class=p>}</span>
        <span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;%#v\n&#34;</span><span class=p>,</span> <span class=nx>place</span><span class=p>)</span>
    <span class=p>}</span>
</code></pre></div><p>特别的:使用<code>db.Get</code>和<code>db.Select</code>可以无需Scan就可以得到自定义数据</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=c1>// Query the database, storing results in a []Person (wrapped in []interface{})
</span><span class=c1></span>    <span class=nx>people</span> <span class=o>:=</span> <span class=p>[]</span><span class=nx>Person</span><span class=p>{}</span>
    <span class=nx>db</span><span class=p>.</span><span class=nf>Select</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>people</span><span class=p>,</span> <span class=s>&#34;SELECT * FROM person ORDER BY first_name ASC&#34;</span><span class=p>)</span>
    <span class=nx>jason</span><span class=p>,</span> <span class=nx>john</span> <span class=o>:=</span> <span class=nx>people</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=nx>people</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>

    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;%#v\n%#v&#34;</span><span class=p>,</span> <span class=nx>jason</span><span class=p>,</span> <span class=nx>john</span><span class=p>)</span>
    <span class=c1>// Person{FirstName:&#34;Jason&#34;, LastName:&#34;Moiron&#34;, Email:&#34;jmoiron@jmoiron.net&#34;}
</span><span class=c1></span>    <span class=c1>// Person{FirstName:&#34;John&#34;, LastName:&#34;Doe&#34;, Email:&#34;johndoeDNE@gmail.net&#34;}
</span><span class=c1></span>
    <span class=c1>// You can also get a single result, a la QueryRow
</span><span class=c1></span>    <span class=nx>jason</span> <span class=p>=</span> <span class=nx>Person</span><span class=p>{}</span>
    <span class=nx>err</span> <span class=p>=</span> <span class=nx>db</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>jason</span><span class=p>,</span> <span class=s>&#34;SELECT * FROM person WHERE first_name=$1&#34;</span><span class=p>,</span> <span class=s>&#34;Jason&#34;</span><span class=p>)</span>
    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;%#v\n&#34;</span><span class=p>,</span> <span class=nx>jason</span><span class=p>)</span>
    <span class=c1>// Person{FirstName:&#34;Jason&#34;, LastName:&#34;Moiron&#34;, Email:&#34;jmoiron@jmoiron.net&#34;}
</span><span class=c1></span>
    <span class=c1>// 注意
</span><span class=c1></span>    <span class=c1>// if you have null fields and use SELECT *, you must use sql.Null* in your struct
</span><span class=c1></span>    <span class=nx>places</span> <span class=o>:=</span> <span class=p>[]</span><span class=nx>Place</span><span class=p>{}</span>
    <span class=nx>err</span> <span class=p>=</span> <span class=nx>db</span><span class=p>.</span><span class=nf>Select</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>places</span><span class=p>,</span> <span class=s>&#34;SELECT * FROM place ORDER BY telcode ASC&#34;</span><span class=p>)</span>
    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
        <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
        <span class=k>return</span>
    <span class=p>}</span>
    <span class=nx>usa</span><span class=p>,</span> <span class=nx>singsing</span><span class=p>,</span> <span class=nx>honkers</span> <span class=o>:=</span> <span class=nx>places</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=nx>places</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=nx>places</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span>

    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;%#v\n%#v\n%#v\n&#34;</span><span class=p>,</span> <span class=nx>usa</span><span class=p>,</span> <span class=nx>singsing</span><span class=p>,</span> <span class=nx>honkers</span><span class=p>)</span>
    <span class=c1>// Place{Country:&#34;United States&#34;, City:sql.NullString{String:&#34;New York&#34;, Valid:true}, TelCode:1}
</span><span class=c1></span>    <span class=c1>// Place{Country:&#34;Singapore&#34;, City:sql.NullString{String:&#34;&#34;, Valid:false}, TelCode:65}
</span><span class=c1></span>    <span class=c1>// Place{Country:&#34;Hong Kong&#34;, City:sql.NullString{String:&#34;&#34;, Valid:false}, TelCode:852}
</span></code></pre></div><p>对于事务操作,看如下示例</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go> <span class=c1>// exec the schema or fail; multi-statement Exec behavior varies between
</span><span class=c1></span>    <span class=c1>// database drivers;  pq will exec them all, sqlite3 won&#39;t, ymmv
</span><span class=c1></span>    <span class=nx>db</span><span class=p>.</span><span class=nf>MustExec</span><span class=p>(</span><span class=nx>schema</span><span class=p>)</span>
    <span class=c1>// 1
</span><span class=c1></span>    <span class=nx>tx</span> <span class=o>:=</span> <span class=nx>db</span><span class=p>.</span><span class=nf>Beginx</span><span class=p>()</span>
    <span class=c1>// 2
</span><span class=c1></span>    <span class=nx>tx</span><span class=p>.</span><span class=nf>Exec</span><span class=p>(</span><span class=s>&#34;INSERT INTO person (first_name, last_name, email) VALUES ($1, $2, $3)&#34;</span><span class=p>,</span> <span class=s>&#34;Jason&#34;</span><span class=p>,</span> <span class=s>&#34;Moiron&#34;</span><span class=p>,</span> <span class=s>&#34;jmoiron@jmoiron.net&#34;</span><span class=p>)</span>
    <span class=nx>tx</span><span class=p>.</span><span class=nf>Exec</span><span class=p>(</span><span class=s>&#34;INSERT INTO person (first_name, last_name, email) VALUES ($1, $2, $3)&#34;</span><span class=p>,</span> <span class=s>&#34;John&#34;</span><span class=p>,</span> <span class=s>&#34;Doe&#34;</span><span class=p>,</span> <span class=s>&#34;johndoeDNE@gmail.net&#34;</span><span class=p>)</span>
    <span class=nx>tx</span><span class=p>.</span><span class=nf>Exec</span><span class=p>(</span><span class=s>&#34;INSERT INTO place (country, city, telcode) VALUES ($1, $2, $3)&#34;</span><span class=p>,</span> <span class=s>&#34;United States&#34;</span><span class=p>,</span> <span class=s>&#34;New York&#34;</span><span class=p>,</span> <span class=s>&#34;1&#34;</span><span class=p>)</span>
    <span class=nx>tx</span><span class=p>.</span><span class=nf>Exec</span><span class=p>(</span><span class=s>&#34;INSERT INTO place (country, telcode) VALUES ($1, $2)&#34;</span><span class=p>,</span> <span class=s>&#34;Hong Kong&#34;</span><span class=p>,</span> <span class=s>&#34;852&#34;</span><span class=p>)</span>
    <span class=nx>tx</span><span class=p>.</span><span class=nf>Exec</span><span class=p>(</span><span class=s>&#34;INSERT INTO place (country, telcode) VALUES ($1, $2)&#34;</span><span class=p>,</span> <span class=s>&#34;Singapore&#34;</span><span class=p>,</span> <span class=s>&#34;65&#34;</span><span class=p>)</span>
    <span class=c1>// Named queries can use structs, so if you have an existing struct (i.e. person := &amp;Person{}) that you have populated, you can pass it in as &amp;person
</span><span class=c1></span>    <span class=nx>tx</span><span class=p>.</span><span class=nf>NamedExec</span><span class=p>(</span><span class=s>&#34;INSERT INTO person (first_name, last_name, email) VALUES (:first_name, :last_name, :email)&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>Person</span><span class=p>{</span><span class=s>&#34;Jane&#34;</span><span class=p>,</span> <span class=s>&#34;Citizen&#34;</span><span class=p>,</span> <span class=s>&#34;jane.citzen@example.com&#34;</span><span class=p>})</span>
    <span class=c1>// 3
</span><span class=c1></span>    <span class=nx>tx</span><span class=p>.</span><span class=nf>Commit</span><span class=p>()</span>
</code></pre></div>
</div>
</article>
<hr>
<div class=post-info>
<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg>
<span class=tag><a href=https://reggieteng.github.io/tags/golang/>golang</a></span>
<span class=tag><a href=https://reggieteng.github.io/tags/go/>go</a></span>
<span class=tag><a href=https://reggieteng.github.io/tags/sqlx/>sqlx</a></span>
</p>
<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-folder meta-icon"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg>
<span class=tag><a href=https://reggieteng.github.io/categories/golang/>golang</a></span>
</p>
<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
779 Words
</p>
<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
2021-05-14
</p>
</div>
<div class=pagination>
<div class=pagination__title>
<span class=pagination__title-h></span>
<hr>
</div>
<div class=pagination__buttons>
<span class="button previous">
<a href=https://reggieteng.github.io/posts/2021/08/nginx%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/>
<span class=button__icon>←</span>
<span class=button__text>nginx配置文件</span>
</a>
</span>
<span class="button next">
<a href=https://reggieteng.github.io/posts/2021/04/golang-strconv/>
<span class=button__text>golang--strconv</span>
<span class=button__icon>→</span>
</a>
</span>
</div>
</div>
</main>
</div>
<footer class=footer>
</footer>
</div>
<script type=text/javascript src=https://reggieteng.github.io/bundle.min.599099f1f14b78b657d524b28e10e0c5098e7cd46e9c7aed73d577068a276c3ff1bb234cbf29cb313333e83cf411727b43157c91ce5b809e2ffc81664614608e.js integrity="sha512-WZCZ8fFLeLZX1SSyjhDgxQmOfNRunHrtc9V3BoonbD/xuyNMvynLMTMz6Dz0EXJ7QxV8kc5bgJ4v/IFmRhRgjg=="></script>
</body>
</html>